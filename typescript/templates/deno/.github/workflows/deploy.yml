name: Register to Restate

on:
  repository_dispatch:
    # This is triggered by Deno Deploy on successful builds
    types: [deno_deploy.build.routed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Register Restate deployment
        env:
          # Admin URL of your Cloud environment. You can find it in Developers > Admin URL: https://cloud.restate.dev/to/developers/integration#admin
          RESTATE_ADMIN_URL: ${{ secrets.RESTATE_ADMIN_URL }}
          # Auth token with Admin Role. To get one, go to Developers > API Keys > Create API Key: https://cloud.restate.dev?createApiKey=true&createApiKeyDescription=deployment-key&createApiKeyRole=rst:role::AdminAccess
          RESTATE_AUTH_TOKEN: ${{ secrets.RESTATE_AUTH_TOKEN }}
        # Revision URL https://docs.deno.com/deploy/classic/deployments/#production-vs.-preview-deployments
        run: npx -y @restatedev/restate deployment register -y ${{ github.event.client_payload.revision.preview_url }}