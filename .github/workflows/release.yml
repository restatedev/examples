name: Create new release

on:
  push:
    tags:
      - v**

jobs:
  publish-release:
    # prevent from running on forks
    if: github.repository_owner == 'restatedev'
    name: Publish release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Prepare zip files
        run: ./.tools/prepare_release_zip.sh

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          # create a draft release which needs manual approval
          draft: true
          # NOTE: order here matters!
          files: |
                  python-hello-world.zip
                  python-hello-world-lambda.zip
                  python-hello-world-lambda-cdk.zip
                  python-tour-of-orchestration.zip
                  python-tour-of-workflows.zip
                  python-basics.zip
                  python-patterns-use-cases.zip
                  python-chat-bot.zip
                  python-food-ordering.zip
                  python-rag-ingestion.zip
            
                  java-hello-world-gradle.zip
                  java-hello-world-maven.zip
                  java-hello-world-new-api-gradle.zip
                  java-hello-world-new-api-maven.zip
                  java-hello-world-maven-spring-boot.zip
                  java-hello-world-new-api-maven-spring-boot.zip
                  java-hello-world-maven-quarkus.zip
                  java-hello-world-lambda-cdk.zip
                  java-tour-of-orchestration.zip
                  java-tour-of-workflows.zip
                  java-basics.zip
                  java-patterns-use-cases.zip
                  java-food-ordering.zip
                  java-subway-fare-calculator.zip
                  java-workflow-interpreter.zip
            
                  kotlin-hello-world-gradle.zip
                  kotlin-hello-world-gradle-spring-boot.zip
                  kotlin-basics.zip
                  kotlin-patterns-use-cases.zip
                  kotlin-food-ordering.zip
                  kotlin-kmp-android-todo-app.zip
                  kotlin-hello-world-lambda-cdk.zip
            
                  typescript-hello-world.zip
                  typescript-hello-world-bun.zip
                  typescript-hello-world-cloudflare-worker.zip
                  typescript-hello-world-deno.zip
                  typescript-hello-world-vercel.zip
                  typescript-hello-world-lambda.zip
                  typescript-hello-world-lambda-cdk.zip
                  typescript-tour-of-orchestration.zip
                  typescript-tour-of-workflows.zip
                  typescript-food-ordering.zip
                  typescript-basics.zip
                  typescript-patterns-use-cases.zip
                  typescript-chat-bot.zip
                  typescript-ai-image-workflows.zip
                  typescript-nextjs-fullstack.zip
            
                  go-hello-world.zip
                  go-hello-world-lambda-cdk.zip
                  go-tour-of-orchestration.zip
                  go-tour-of-workflows.zip
                  go-basics.zip
                  go-patterns-use-cases.zip
                  go-knative-go.zip
            
                  rust-hello-world.zip
                  rust-hello-world-shuttle.zip
                  rust-basics.zip



  copy-deno-template:
    name: Copy deno template to deno-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: typescript/templates/deno
      destination-repo: deno-template
  copy-vercel-template:
    name: Copy vercel template to vercel-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: typescript/templates/vercel
      destination-repo: vercel-template
  copy-cloudflare-workers-template:
    name: Copy cloudflare-worker template to cloudflare-workers-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: typescript/templates/cloudflare-worker
      destination-repo: cloudflare-workers-template
  copy-ts-lambda-template:
    name: Copy Typescript Lambda template to lambda-typescript-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: typescript/templates/lambda
      destination-repo: lambda-typescript-template
  copy-py-lambda-template:
    name: Copy Python Lambda template to lambda-python-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: python/templates/lambda
      destination-repo: lambda-python-template
  copy-java-maven-template:
    name: Copy Java Maven template to java-maven-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: java/templates/java-maven
      destination-repo: java-maven-template
  copy-java-gradle-template:
    name: Copy Java Gradle template to java-gradle-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: java/templates/java-gradle
      destination-repo: java-gradle-template
  copy-java-spring-boot-template:
    name: Copy Java Spring boot template to java-spring-boot-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: java/templates/java-maven-spring-boot
      destination-repo: java-spring-boot-template
  copy-java-new-api-maven-template:
    name: Copy Java New API Maven template to java-new-api-maven-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: java/templates/java-new-api-maven
      destination-repo: java-new-api-maven-template
  copy-java-new-api-gradle-template:
    name: Copy Java New API Gradle template to java-new-api-gradle-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: java/templates/java-new-api-gradle
      destination-repo: java-new-api-gradle-template
  copy-java-new-api-spring-boot-template:
    name: Copy Java New API Spring boot template to java-new-api-spring-boot-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: java/templates/java-new-api-maven-spring-boot
      destination-repo: java-new-api-spring-boot-template
  copy-kotlin-template:
    name: Copy Kotlin template to kotlin-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: kotlin/templates/kotlin-gradle
      destination-repo: kotlin-template
  copy-kotlin-spring-boot-template:
    name: Copy Kotlin Spring boot template to kotlin-spring-boot-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: kotlin/templates/kotlin-gradle-spring-boot
      destination-repo: kotlin-spring-boot-template
  copy-go-template:
    name: Copy Go template to go-template repo
    uses: ./.github/workflows/copy-to-repo.yml
    secrets: inherit
    with:
      source-directory: go/templates/go
      destination-repo: go-template